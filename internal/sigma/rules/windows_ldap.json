{
  "metadata": {
    "logsource": "windows_ldap",
    "rule_count": 1,
    "compiled_at": "2026-02-04T12:28:36.403889",
    "version": "1.1"
  },
  "rules": [
    {
      "id": "31d68132-4038-47c7-8f8e-635a39a7c174",
      "title": "Potential Active Directory Reconnaissance/Enumeration Via LDAP",
      "status": "test",
      "description": "Detects potential Active Directory enumeration via LDAP",
      "level": "medium",
      "tags": [
        "attack.discovery",
        "attack.t1069.002",
        "attack.t1087.002",
        "attack.t1482"
      ],
      "logsource": {
        "category": null,
        "product": "windows",
        "service": "ldap"
      },
      "detection": {
        "selections": {
          "generic_search": {
            "type": "field_match",
            "matchers": {
              "EventID": {
                "field": "EventID",
                "value": 30,
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "SearchFilter__contains": {
                "field": "SearchFilter",
                "value": [
                  "(groupType:1.2.840.113556.1.4.803:=2147483648)",
                  "(groupType:1.2.840.113556.1.4.803:=2147483656)",
                  "(groupType:1.2.840.113556.1.4.803:=2147483652)",
                  "(groupType:1.2.840.113556.1.4.803:=2147483650)",
                  "(sAMAccountType=805306369)",
                  "(sAMAccountType=805306368)",
                  "(sAMAccountType=536870913)",
                  "(sAMAccountType=536870912)",
                  "(sAMAccountType=268435457)",
                  "(sAMAccountType=268435456)",
                  "(objectCategory=groupPolicyContainer)",
                  "(objectCategory=organizationalUnit)",
                  "(objectCategory=nTDSDSA)",
                  "(objectCategory=server)",
                  "(objectCategory=domain)",
                  "(objectCategory=person)",
                  "(objectCategory=group)",
                  "(objectCategory=user)",
                  "(objectClass=trustedDomain)",
                  "(objectClass=computer)",
                  "(objectClass=server)",
                  "(objectClass=group)",
                  "(objectClass=user)",
                  "(primaryGroupID=521)",
                  "(primaryGroupID=516)",
                  "(primaryGroupID=515)",
                  "(primaryGroupID=512)",
                  "Domain Admins",
                  "objectGUID=\\*",
                  "(schemaIDGUID=\\*)",
                  "admincount=1"
                ],
                "modifiers": [
                  "contains"
                ],
                "is_list": true,
                "negated": false
              }
            }
          },
          "distinguished_name_enumeration": {
            "type": "field_match",
            "matchers": {
              "EventID": {
                "field": "EventID",
                "value": 30,
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "SearchFilter": {
                "field": "SearchFilter",
                "value": "(objectclass=\\*)",
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "DistinguishedName__contains": {
                "field": "DistinguishedName",
                "value": [
                  "CN=Domain Admins",
                  "CN=Enterprise Admins",
                  "CN=Group Policy Creator Owners"
                ],
                "modifiers": [
                  "contains"
                ],
                "is_list": true,
                "negated": false
              }
            }
          },
          "suspicious_flag": {
            "type": "field_match",
            "matchers": {
              "EventID": {
                "field": "EventID",
                "value": 30,
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "SearchFilter__contains": {
                "field": "SearchFilter",
                "value": [
                  "(userAccountControl:1.2.840.113556.1.4.803:=4194304)",
                  "(userAccountControl:1.2.840.113556.1.4.803:=2097152)",
                  "!(userAccountControl:1.2.840.113556.1.4.803:=1048574)",
                  "(userAccountControl:1.2.840.113556.1.4.803:=524288)",
                  "(userAccountControl:1.2.840.113556.1.4.803:=65536)",
                  "(userAccountControl:1.2.840.113556.1.4.803:=8192)",
                  "(userAccountControl:1.2.840.113556.1.4.803:=544)",
                  "!(UserAccountControl:1.2.840.113556.1.4.803:=2)",
                  "msDS-AllowedToActOnBehalfOfOtherIdentity",
                  "msDS-AllowedToDelegateTo",
                  "msDS-GroupManagedServiceAccount",
                  "(accountExpires=9223372036854775807)",
                  "(accountExpires=0)",
                  "(adminCount=1)",
                  "ms-MCS-AdmPwd"
                ],
                "modifiers": [
                  "contains"
                ],
                "is_list": true,
                "negated": false
              }
            }
          },
          "narrow_down_filter": {
            "type": "field_match",
            "matchers": {
              "EventID": {
                "field": "EventID",
                "value": 30,
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "SearchFilter__contains": {
                "field": "SearchFilter",
                "value": [
                  "(domainSid=*)",
                  "(objectSid=*)"
                ],
                "modifiers": [
                  "contains"
                ],
                "is_list": true,
                "negated": false
              }
            }
          }
        },
        "filters": {},
        "condition": "(generic_search and not narrow_down_filter) or suspicious_flag or distinguished_name_enumeration",
        "condition_parsed": {
          "op": "or",
          "operands": [
            "(generic_search and not narrow_down_filter)",
            "suspicious_flag",
            "distinguished_name_enumeration"
          ]
        }
      },
      "mitre": {
        "techniques": [
          "T1069.002",
          "T1087.002",
          "T1482"
        ],
        "tactics": [
          "discovery"
        ]
      },
      "meta": {
        "author": "Adeem Mawani",
        "date": "2021-06-22",
        "modified": "2025-07-04",
        "references": [
          "https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/hunting-for-reconnaissance-activities-using-ldap-search-filters/ba-p/824726",
          "https://github.com/PowerShellMafia/PowerSploit/blob/d943001a7defb5e0d1657085a77a0e78609be58f/Recon/PowerView.ps1",
          "https://github.com/BloodHoundAD/SharpHound3/blob/7d96b991b1887ff50349ce59c80980bc0d95c86a/SharpHound3/LdapBuilder.cs",
          "https://medium.com/falconforce/falconfriday-detecting-active-directory-data-collection-0xff21-c22d1a57494c",
          "https://github.com/fox-it/BloodHound.py/blob/d65eb614831cd30f26028ccb072f5e77ca287e0b/bloodhound/ad/domain.py#L427",
          "https://ipurple.team/2024/07/15/sharphound-detection/"
        ],
        "falsepositives": [],
        "source_file": "sigma_rules/windows/builtin/ldap/win_ldap_recon.yml"
      }
    }
  ]
}