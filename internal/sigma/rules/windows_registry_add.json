{
  "metadata": {
    "logsource": "windows_registry_add",
    "rule_count": 1,
    "compiled_at": "2026-02-04T12:28:36.530821",
    "version": "1.1"
  },
  "rules": [
    {
      "id": "d4f4e0be-cf12-439f-9e25-4e2cdcf7df5a",
      "title": "Potential Persistence Via Disk Cleanup Handler - Registry",
      "status": "test",
      "description": "Detects when an attacker modifies values of the Disk Cleanup Handler in the registry to achieve persistence.\nThe disk cleanup manager is part of the operating system. It displays the dialog box [â€¦]\nThe user has the option of enabling or disabling individual handlers by selecting or clearing their check box in the disk cleanup manager's UI.\nAlthough Windows comes with a number of disk cleanup handlers, they aren't designed to handle files produced by other applications.\nInstead, the disk cleanup manager is designed to be flexible and extensible by enabling any developer to implement and register their own disk cleanup handler.\nAny developer can extend the available disk cleanup services by implementing and registering a disk cleanup handler.\n",
      "level": "medium",
      "tags": [
        "attack.persistence"
      ],
      "logsource": {
        "category": "registry_add",
        "product": "windows",
        "service": null
      },
      "detection": {
        "selections": {
          "selection": {
            "type": "field_match",
            "matchers": {
              "EventType": {
                "field": "EventType",
                "value": "CreateKey",
                "modifiers": [],
                "is_list": false,
                "negated": false
              },
              "TargetObject__contains": {
                "field": "TargetObject",
                "value": "\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VolumeCaches\\",
                "modifiers": [
                  "contains"
                ],
                "is_list": false,
                "negated": false
              }
            }
          }
        },
        "filters": {
          "filter_main_default_keys": {
            "type": "field_match",
            "matchers": {
              "TargetObject__endswith": {
                "field": "TargetObject",
                "value": [
                  "\\Active Setup Temp Folders",
                  "\\BranchCache",
                  "\\Content Indexer Cleaner",
                  "\\D3D Shader Cache",
                  "\\Delivery Optimization Files",
                  "\\Device Driver Packages",
                  "\\Diagnostic Data Viewer database files",
                  "\\Downloaded Program Files",
                  "\\DownloadsFolder",
                  "\\Feedback Hub Archive log files",
                  "\\Internet Cache Files",
                  "\\Language Pack",
                  "\\Microsoft Office Temp Files",
                  "\\Offline Pages Files",
                  "\\Old ChkDsk Files",
                  "\\Previous Installations",
                  "\\Recycle Bin",
                  "\\RetailDemo Offline Content",
                  "\\Setup Log Files",
                  "\\System error memory dump files",
                  "\\System error minidump files",
                  "\\Temporary Files",
                  "\\Temporary Setup Files",
                  "\\Temporary Sync Files",
                  "\\Thumbnail Cache",
                  "\\Update Cleanup",
                  "\\Upgrade Discarded Files",
                  "\\User file versions",
                  "\\Windows Defender",
                  "\\Windows Error Reporting Files",
                  "\\Windows ESD installation files",
                  "\\Windows Upgrade Log Files"
                ],
                "modifiers": [
                  "endswith"
                ],
                "is_list": true,
                "negated": false
              }
            }
          }
        },
        "condition": "selection and not 1 of filter_main_*",
        "condition_parsed": {
          "op": "and",
          "operands": [
            {
              "type": "ref",
              "value": "selection"
            },
            {
              "type": "not",
              "value": "1 of filter_main_*"
            }
          ]
        }
      },
      "mitre": {
        "techniques": [],
        "tactics": [
          "persistence"
        ]
      },
      "meta": {
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "date": "2022-07-21",
        "modified": "2023-02-07",
        "references": [
          "https://persistence-info.github.io/Data/diskcleanuphandler.html",
          "https://www.hexacorn.com/blog/2018/09/02/beyond-good-ol-run-key-part-86/"
        ],
        "falsepositives": [
          "Legitimate new entry added by windows"
        ],
        "source_file": "sigma_rules/windows/registry/registry_add/registry_add_persistence_disk_cleanup_handler_entry.yml"
      }
    }
  ]
}